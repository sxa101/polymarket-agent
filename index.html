<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket 15-Min Crypto Trading Agent</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="description" content="Browser-based trading agent for Polymarket's 15-minute crypto prediction markets">
</head>
<body>
    <div id="app">
        <div id="demo-banner" class="demo-banner" style="display: none;">
            ğŸ® DEMO MODE - Simulated Data Only - No Real Trading
            <button id="toggle-demo" class="demo-toggle">Switch to Live Mode</button>
        </div>
        
        <header class="header">
            <h1>Polymarket Trading Agent</h1>
            <div class="connection-status">
                <div id="demo-status" class="status-indicator">Mode: Demo</div>
                <div id="api-status" class="status-indicator">API: Connecting</div>
                <div id="wallet-status" class="status-indicator">Wallet: Not Connected</div>
                <div id="market-status" class="status-indicator">Markets: Disconnected</div>
                <button id="settings-btn" class="settings-btn" title="Configuration Settings">âš™ï¸</button>
            </div>
        </header>

        <nav class="navigation">
            <button class="nav-btn active" data-view="dashboard">Dashboard</button>
            <button class="nav-btn" data-view="markets">Markets</button>
            <button class="nav-btn" data-view="strategies">Strategies</button>
            <button class="nav-btn" data-view="portfolio">Portfolio</button>
            <button class="nav-btn" data-view="analytics">Analytics</button>
        </nav>

        <main class="main-content">
            <div id="dashboard-view" class="view active">
                <div class="dashboard-grid">
                    <div class="widget" id="active-markets">
                        <h3>Active 15-Min Markets</h3>
                        <div class="market-list"></div>
                    </div>
                    <div class="widget" id="positions">
                        <h3>Active Positions</h3>
                        <div class="positions-list"></div>
                    </div>
                    <div class="widget" id="pnl-summary">
                        <h3>P&L Summary</h3>
                        <div class="pnl-metrics"></div>
                    </div>
                    <div class="widget" id="recent-trades">
                        <h3>Recent Trades</h3>
                        <div class="trades-list"></div>
                    </div>
                </div>
            </div>

            <div id="markets-view" class="view">
                <div class="markets-container">
                    <div class="market-filters">
                        <input type="text" id="asset-filter" placeholder="Filter by asset (BTC, ETH, SOL...)">
                        <button id="refresh-markets">Refresh Markets</button>
                    </div>
                    <div id="markets-grid"></div>
                </div>
            </div>

            <div id="strategies-view" class="view">
                <div class="strategies-container">
                    <div class="strategy-controls">
                        <button id="create-strategy">Create New Strategy</button>
                        <button id="backtest-all">Run Backtests</button>
                    </div>
                    <div id="strategies-list"></div>
                </div>
            </div>

            <div id="portfolio-view" class="view">
                <div class="portfolio-summary">
                    <div class="balance-info">
                        <h3>Portfolio Balance</h3>
                        <div id="total-balance">$0.00</div>
                    </div>
                    <div class="portfolio-breakdown"></div>
                </div>
                <div id="transaction-history"></div>
            </div>

            <div id="analytics-view" class="view">
                <div class="analytics-dashboard">
                    <div class="performance-metrics">
                        <h3>Performance Analytics</h3>
                        <canvas id="performance-chart"></canvas>
                    </div>
                    <div class="strategy-comparison">
                        <h3>Strategy Performance</h3>
                        <div id="strategy-stats"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Modal</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-content" id="modal-content"></div>
        </div>
    </div>

    <!-- DEBUGGING PANEL -->
    <div id="debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: #1a1a1a; color: #00ff00; padding: 15px; font-family: monospace; font-size: 12px; z-index: 9999; border-radius: 8px; max-width: 400px; max-height: 300px; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="color: #ffff00;">ğŸš¨ DEBUGGING PANEL</strong>
            <button onclick="toggleDebugPanel()" style="background: #333; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">Toggle</button>
        </div>
        <div id="debug-output">Initializing diagnostics...</div>
        <div style="margin-top: 10px;">
            <button onclick="runFullDiagnostics()" style="background: #007acc; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">ğŸ” Full Diagnostics</button>
            <button onclick="testWalletConnection()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">ğŸ‘› Test Wallet</button>
            <button onclick="testRealAPI()" style="background: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ğŸŒ Test API</button>
        </div>
    </div>

    <script>
        // Debug Panel Functions
        let debugPanelVisible = true;
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (debugPanelVisible) {
                panel.style.transform = 'translateY(calc(100% - 40px))';
                debugPanelVisible = false;
            } else {
                panel.style.transform = 'translateY(0)';
                debugPanelVisible = true;
            }
        }

        function runFullDiagnostics() {
            const output = document.getElementById('debug-output');
            const diagnostics = [];
            
            try {
                // Check basic environment
                diagnostics.push(`ğŸŒ <strong>ENVIRONMENT:</strong>`);
                diagnostics.push(`â”œâ”€ URL: ${window.location.href}`);
                diagnostics.push(`â”œâ”€ Protocol: ${window.location.protocol}`);
                diagnostics.push(`â””â”€ Host: ${window.location.host}`);
                diagnostics.push(``);
                
                // Check MetaMask
                diagnostics.push(`ğŸ¦Š <strong>METAMASK:</strong>`);
                diagnostics.push(`â”œâ”€ Available: ${typeof window.ethereum !== 'undefined' ? 'âœ… YES' : 'âŒ NO'}`);
                diagnostics.push(`â”œâ”€ Is MetaMask: ${window.ethereum?.isMetaMask ? 'âœ… YES' : 'âŒ NO'}`);
                diagnostics.push(`â””â”€ Provider: ${window.ethereum ? 'âœ… FOUND' : 'âŒ MISSING'}`);
                diagnostics.push(``);
                
                // Check Configuration
                diagnostics.push(`âš™ï¸ <strong>CONFIGURATION:</strong>`);
                if (typeof ProductionConfig !== 'undefined') {
                    diagnostics.push(`â”œâ”€ Config Loaded: âœ… YES`);
                    diagnostics.push(`â”œâ”€ Demo Mode: ${ProductionConfig.FEATURES?.DEMO_MODE ? 'ğŸ® YES' : 'ğŸš€ NO'}`);
                    diagnostics.push(`â”œâ”€ Trading Enabled: ${ProductionConfig.FEATURES?.ENABLE_TRADING ? 'âœ… YES' : 'âŒ NO'}`);
                    diagnostics.push(`â”œâ”€ Testnet Mode: ${ProductionConfig.FEATURES?.TESTNET_MODE ? 'ğŸ§ª YES' : 'ğŸŒ MAINNET'}`);
                    diagnostics.push(`â””â”€ Risk Management: ${ProductionConfig.FEATURES?.ENABLE_RISK_MANAGEMENT ? 'âœ… YES' : 'âŒ NO'}`);
                } else {
                    diagnostics.push(`â”œâ”€ Config Loaded: âŒ NO - CRITICAL ERROR!`);
                    diagnostics.push(`â””â”€ This means ProductionConfig is not available globally`);
                }
                diagnostics.push(``);
                
                // Check App Instance
                diagnostics.push(`ğŸš€ <strong>APPLICATION:</strong>`);
                if (window.tradingAgent) {
                    diagnostics.push(`â”œâ”€ App Instance: âœ… FOUND`);
                    diagnostics.push(`â”œâ”€ Demo Mode: ${window.tradingAgent.isDemoMode ? 'ğŸ® YES' : 'ğŸš€ NO'}`);
                    diagnostics.push(`â”œâ”€ Initialized: ${window.tradingAgent.isInitialized ? 'âœ… YES' : 'â³ PENDING'}`);
                    
                    // Check components
                    if (window.tradingAgent.components) {
                        const comp = window.tradingAgent.components;
                        diagnostics.push(`â”œâ”€ Database: ${comp.database ? 'âœ… ' + comp.database.constructor.name : 'âŒ MISSING'}`);
                        diagnostics.push(`â”œâ”€ API: ${comp.api ? 'âœ… ' + comp.api.constructor.name : 'âŒ MISSING'}`);
                        diagnostics.push(`â”œâ”€ Wallet: ${comp.wallet ? 'âœ… ' + comp.wallet.constructor.name : 'âŒ MISSING'}`);
                        diagnostics.push(`â”œâ”€ WebSocket: ${comp.webSocket ? 'âœ… ' + comp.webSocket.constructor.name : 'âŒ MISSING'}`);
                        diagnostics.push(`â””â”€ Trading Engine: ${comp.tradingEngine ? 'âœ… ' + comp.tradingEngine.constructor.name : 'âŒ MISSING'}`);
                    } else {
                        diagnostics.push(`â””â”€ Components: âŒ NOT INITIALIZED`);
                    }
                } else {
                    diagnostics.push(`â”œâ”€ App Instance: âŒ NOT FOUND`);
                    diagnostics.push(`â””â”€ Check console for initialization errors`);
                }
                diagnostics.push(``);
                
                // Check initialization status
                if (window.tradingAgent?.initializationStatus) {
                    diagnostics.push(`ğŸ“Š <strong>INITIALIZATION STATUS:</strong>`);
                    const status = window.tradingAgent.initializationStatus;
                    Object.entries(status).forEach(([key, value]) => {
                        const icon = value === 'success' ? 'âœ…' : value === 'error' ? 'âŒ' : 'â³';
                        diagnostics.push(`â”œâ”€ ${key}: ${icon} ${value.toUpperCase()}`);
                    });
                    diagnostics.push(``);
                }
                
                // Check errors
                if (window.tradingAgent?.errors?.length > 0) {
                    diagnostics.push(`ğŸš¨ <strong>ERRORS FOUND:</strong>`);
                    window.tradingAgent.errors.forEach((error, index) => {
                        diagnostics.push(`â”œâ”€ ${error.component}: ${error.error}`);
                    });
                }
                
            } catch (error) {
                diagnostics.push(`ğŸš¨ <strong>DIAGNOSTIC ERROR:</strong> ${error.message}`);
            }
            
            output.innerHTML = diagnostics.join('<br>');
        }

        async function testWalletConnection() {
            const output = document.getElementById('debug-output');
            output.innerHTML = `ğŸ§ª <strong>Testing Wallet Connection...</strong><br>`;
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    output.innerHTML += `âŒ MetaMask not available<br>`;
                    return;
                }
                
                if (!window.tradingAgent?.components?.wallet) {
                    output.innerHTML += `âŒ Wallet Manager not initialized<br>`;
                    return;
                }
                
                output.innerHTML += `â³ Connecting to wallet...<br>`;
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length > 0) {
                    output.innerHTML += `âœ… Wallet connected: ${accounts[0]}<br>`;
                    output.innerHTML += `ğŸ”— Address: ${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}<br>`;
                    
                    // Test network
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    output.innerHTML += `ğŸŒ Network: ${chainId} (${chainId === '0x89' ? 'Polygon' : chainId === '0x13881' ? 'Mumbai' : 'Other'})<br>`;
                } else {
                    output.innerHTML += `âŒ No accounts available<br>`;
                }
                
            } catch (error) {
                output.innerHTML += `âŒ Wallet connection failed: ${error.message}<br>`;
            }
        }

        async function testRealAPI() {
            const output = document.getElementById('debug-output');
            output.innerHTML = `ğŸ§ª <strong>Testing Real API Connection...</strong><br>`;
            
            try {
                if (!window.tradingAgent?.components?.api) {
                    output.innerHTML += `âŒ API not initialized<br>`;
                    return;
                }
                
                const api = window.tradingAgent.components.api;
                output.innerHTML += `â³ API Type: ${api.constructor.name}<br>`;
                
                if (api.constructor.name === 'MockAPI') {
                    output.innerHTML += `ğŸ® Using demo API - not real Polymarket<br>`;
                    return;
                }
                
                if (api.constructor.name === 'RealPolymarketAPI') {
                    output.innerHTML += `ğŸš€ Real Polymarket API detected!<br>`;
                    output.innerHTML += `â³ Testing API health...<br>`;
                    
                    // Test health check
                    const healthy = await api.healthCheck();
                    output.innerHTML += `ğŸ“Š Health check: ${healthy ? 'âœ… PASS' : 'âŒ FAIL'}<br>`;
                    
                    if (healthy) {
                        output.innerHTML += `â³ Fetching real markets...<br>`;
                        const markets = await api.fetchRealCryptoMarkets();
                        output.innerHTML += `ğŸ“ˆ Found ${markets.length} real markets<br>`;
                        
                        if (markets.length > 0) {
                            output.innerHTML += `ğŸ’ Sample market: ${markets[0].question.slice(0,50)}...<br>`;
                        }
                    }
                }
                
            } catch (error) {
                output.innerHTML += `âŒ API test failed: ${error.message}<br>`;
                console.error('API test error:', error);
            }
        }

        // Auto-run diagnostics when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log("ğŸ” Running automatic diagnostics...");
                runFullDiagnostics();
            }, 3000); // Wait 3 seconds for app to initialize
        });
    </script>

    <script type="module" src="js/app-working.js"></script>
</body>
</html>